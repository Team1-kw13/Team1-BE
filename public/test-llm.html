<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LLM Service Test</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f7fa;
            }
            .container {
                background: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .section {
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #e1e8ed;
                border-radius: 8px;
                background-color: #fafbfc;
            }
            .section h2 {
                color: #34495e;
                margin-top: 0;
                margin-bottom: 15px;
                font-size: 18px;
            }
            .controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
                margin-bottom: 15px;
            }
            input[type="text"],
            textarea {
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                min-width: 200px;
            }
            textarea {
                min-height: 80px;
                resize: vertical;
            }
            button {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: background-color 0.2s;
            }
            .btn-primary {
                background-color: #3498db;
                color: white;
            }
            .btn-primary:hover {
                background-color: #2980b9;
            }
            .btn-success {
                background-color: #27ae60;
                color: white;
            }
            .btn-success:hover {
                background-color: #229954;
            }
            .btn-warning {
                background-color: #f39c12;
                color: white;
            }
            .btn-warning:hover {
                background-color: #e67e22;
            }
            .btn-danger {
                background-color: #e74c3c;
                color: white;
            }
            .btn-danger:hover {
                background-color: #c0392b;
            }
            .status {
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                font-weight: 500;
            }
            .status.connected {
                background-color: #d5f4e6;
                color: #27ae60;
                border: 1px solid #27ae60;
            }
            .status.disconnected {
                background-color: #fadbd8;
                color: #e74c3c;
                border: 1px solid #e74c3c;
            }
            .status.connecting {
                background-color: #fdeaa7;
                color: #f39c12;
                border: 1px solid #f39c12;
            }
            .log {
                background-color: #2c3e50;
                color: #ecf0f1;
                padding: 15px;
                border-radius: 5px;
                height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 12px;
                line-height: 1.4;
            }
            .log-entry {
                margin-bottom: 5px;
                word-wrap: break-word;
            }
            .log-entry.info {
                color: #3498db;
            }
            .log-entry.success {
                color: #27ae60;
            }
            .log-entry.warning {
                color: #f39c12;
            }
            .log-entry.error {
                color: #e74c3c;
            }
            .session-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 15px;
            }
            .info-card {
                background: white;
                padding: 15px;
                border-radius: 5px;
                border-left: 4px solid #3498db;
            }
            .info-card h3 {
                margin: 0 0 10px 0;
                color: #2c3e50;
                font-size: 14px;
            }
            .info-card p {
                margin: 0;
                color: #7f8c8d;
                font-size: 16px;
                font-weight: 500;
            }
            .quick-messages {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
                margin-bottom: 15px;
            }
            .quick-msg {
                background-color: #ecf0f1;
                border: 1px solid #bdc3c7;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                text-align: center;
                font-size: 13px;
                transition: background-color 0.2s;
            }
            .quick-msg:hover {
                background-color: #d5dbdb;
            }
            .response-area {
                background: white;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 15px;
                min-height: 100px;
                margin-top: 10px;
            }
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ü§ñ LLM Service ÌÖåÏä§Ìä∏ ÌôîÎ©¥</h1>

            <!-- Ïó∞Í≤∞ ÏÉÅÌÉú -->
            <div class="section">
                <h2>üì° ÏõπÏÜåÏºì Ïó∞Í≤∞</h2>
                <div id="connectionStatus" class="status disconnected">
                    Ïó∞Í≤∞ ÎÅäÍπÄ
                </div>
                <div class="controls">
                    <input
                        type="text"
                        id="sessionId"
                        placeholder="ÏÑ∏ÏÖò ID (Ïòà: test-session-1)"
                        value="test-session-1"
                    />
                    <button id="connectBtn" class="btn-primary">Ïó∞Í≤∞</button>
                    <button id="disconnectBtn" class="btn-danger" disabled>
                        Ïó∞Í≤∞ ÎÅäÍ∏∞
                    </button>
                </div>
            </div>

            <!-- ÏÑ∏ÏÖò Ï†ïÎ≥¥ -->
            <div class="section">
                <h2>üìä ÏÑ∏ÏÖò Ï†ïÎ≥¥</h2>
                <div class="session-info">
                    <div class="info-card">
                        <h3>ÏÑ∏ÏÖò ID</h3>
                        <p id="currentSessionId">-</p>
                    </div>
                    <div class="info-card">
                        <h3>ÏÉÅÌÉú</h3>
                        <p id="sessionStatus">ÎπÑÌôúÏÑ±</p>
                    </div>
                    <div class="info-card">
                        <h3>ÏùºÏãúÏ†ïÏßÄ</h3>
                        <p id="pauseStatus">Ï†ïÏÉÅ</p>
                    </div>
                    <div class="info-card">
                        <h3>Î©îÏãúÏßÄ Ïàò</h3>
                        <p id="messageCount">0</p>
                    </div>
                </div>
                <div class="controls">
                    <button id="pauseBtn" class="btn-warning" disabled>
                        ÏùºÏãúÏ†ïÏßÄ
                    </button>
                    <button id="resumeBtn" class="btn-success" disabled>
                        Ïû¨Í∞ú
                    </button>
                    <button id="sessionInfoBtn" class="btn-primary" disabled>
                        ÏÑ∏ÏÖò Ï†ïÎ≥¥ Ï°∞Ìöå
                    </button>
                </div>
            </div>

            <!-- Î©îÏãúÏßÄ Ï†ÑÏÜ° -->
            <div class="section">
                <h2>üí¨ Î©îÏãúÏßÄ Ï†ÑÏÜ°</h2>
                <div class="quick-messages">
                    <div
                        class="quick-msg"
                        data-msg="Î≥µÏßÄ ÌòúÌÉùÏóê ÎåÄÌï¥ ÏïåÎ†§Ï£ºÏÑ∏Ïöî"
                    >
                        Î≥µÏßÄ ÌòúÌÉù Î¨∏Ïùò
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="ÏùòÎ£åÎπÑ ÏßÄÏõêÏùÄ Ïñ¥ÎñªÍ≤å Î∞õÎÇòÏöî?"
                    >
                        ÏùòÎ£åÎπÑ ÏßÄÏõê Î¨∏Ïùò
                    </div>
                    <div class="quick-msg" data-msg="Ï£ºÍ±∞ ÏßÄÏõê Ï†ïÏ±ÖÏù¥ ÏûàÎÇòÏöî?">
                        Ï£ºÍ±∞ ÏßÄÏõê Î¨∏Ïùò
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="ÍµêÏú°ÎπÑ ÏßÄÏõê Ï†úÎèÑÍ∞Ä Í∂ÅÍ∏àÌï©ÎãàÎã§"
                    >
                        ÍµêÏú°ÎπÑ ÏßÄÏõê Î¨∏Ïùò
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="ÍµêÌÜµÎπÑ Ìï†Ïù∏ ÌòúÌÉùÏùÄ Î≠êÍ∞Ä ÏûàÎÇòÏöî?"
                    >
                        ÍµêÌÜµÎπÑ Ìï†Ïù∏ Î¨∏Ïùò
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="ÏïàÎÖïÌïòÏÑ∏Ïöî. Ï≤òÏùå Ïù¥Ïö©Ìï©ÎãàÎã§."
                    >
                        Ïù∏ÏÇ¨Îßê
                    </div>
                </div>
                <div class="controls">
                    <textarea
                        id="messageInput"
                        placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                    ></textarea>
                    <button id="sendBtn" class="btn-success" disabled>
                        Ï†ÑÏÜ°
                    </button>
                </div>
                <div
                    id="ragSources"
                    style="margin-top: 10px; font-size: 12px; color: #7f8c8d"
                ></div>
                <div class="response-area" id="responseArea">
                    <p style="color: #95a5a6; font-style: italic">
                        ÏùëÎãµÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§...
                    </p>
                </div>
            </div>

            <!-- Ïù¥Î≤§Ìä∏ Î°úÍ∑∏ -->
            <div class="section">
                <h2>üìã Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏</h2>
                <div class="controls">
                    <button id="clearLogBtn" class="btn-warning">
                        Î°úÍ∑∏ ÏßÄÏö∞Í∏∞
                    </button>
                    <button id="exportLogBtn" class="btn-primary">
                        Î°úÍ∑∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                    </button>
                </div>
                <div id="eventLog" class="log"></div>
            </div>
        </div>

        <script>
            class LLMTestClient {
                constructor() {
                    this.ws = null;
                    this.currentSessionId = null;
                    this.messageCount = 0;
                    this.isPaused = false;
                    this.currentResponse = "";

                    this.initElements();
                    this.bindEvents();
                    this.log("üöÄ LLM ÌÖåÏä§Ìä∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å", "success");
                }

                initElements() {
                    this.elements = {
                        sessionId: document.getElementById("sessionId"),
                        connectBtn: document.getElementById("connectBtn"),
                        disconnectBtn: document.getElementById("disconnectBtn"),
                        connectionStatus:
                            document.getElementById("connectionStatus"),
                        currentSessionId:
                            document.getElementById("currentSessionId"),
                        sessionStatus: document.getElementById("sessionStatus"),
                        pauseStatus: document.getElementById("pauseStatus"),
                        messageCount: document.getElementById("messageCount"),
                        pauseBtn: document.getElementById("pauseBtn"),
                        resumeBtn: document.getElementById("resumeBtn"),
                        sessionInfoBtn:
                            document.getElementById("sessionInfoBtn"),
                        messageInput: document.getElementById("messageInput"),
                        sendBtn: document.getElementById("sendBtn"),
                        ragSources: document.getElementById("ragSources"),
                        responseArea: document.getElementById("responseArea"),
                        eventLog: document.getElementById("eventLog"),
                        clearLogBtn: document.getElementById("clearLogBtn"),
                        exportLogBtn: document.getElementById("exportLogBtn"),
                    };
                }

                bindEvents() {
                    this.elements.connectBtn.addEventListener("click", () =>
                        this.connect()
                    );
                    this.elements.disconnectBtn.addEventListener("click", () =>
                        this.disconnect()
                    );
                    this.elements.pauseBtn.addEventListener("click", () =>
                        this.pauseSession()
                    );
                    this.elements.resumeBtn.addEventListener("click", () =>
                        this.resumeSession()
                    );
                    this.elements.sessionInfoBtn.addEventListener("click", () =>
                        this.getSessionInfo()
                    );
                    this.elements.sendBtn.addEventListener("click", () =>
                        this.sendMessage()
                    );
                    this.elements.clearLogBtn.addEventListener("click", () =>
                        this.clearLog()
                    );
                    this.elements.exportLogBtn.addEventListener("click", () =>
                        this.exportLog()
                    );

                    // Îπ†Î•∏ Î©îÏãúÏßÄ Î≤ÑÌäºÎì§
                    document.querySelectorAll(".quick-msg").forEach((btn) => {
                        btn.addEventListener("click", (e) => {
                            const message = e.target.getAttribute("data-msg");
                            this.elements.messageInput.value = message;
                            this.sendMessage();
                        });
                    });

                    // Enter ÌÇ§Î°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
                    this.elements.messageInput.addEventListener(
                        "keypress",
                        (e) => {
                            if (e.key === "Enter" && !e.shiftKey) {
                                e.preventDefault();
                                this.sendMessage();
                            }
                        }
                    );
                }

                connect() {
                    const sessionId = this.elements.sessionId.value.trim();
                    if (!sessionId) {
                        alert("ÏÑ∏ÏÖò IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }

                    this.log(`üîó ÏÑ∏ÏÖò Ïó∞Í≤∞ ÏãúÎèÑ: ${sessionId}`, "info");
                    this.updateConnectionStatus("connecting");

                    this.ws = new WebSocket("ws://localhost:3000/voice");
                    this.currentSessionId = sessionId;

                    this.ws.onopen = () => {
                        this.log("‚úÖ ÏõπÏÜåÏºì Ïó∞Í≤∞ ÏÑ±Í≥µ", "success");
                        this.updateConnectionStatus("connected");

                        // ÏÑ∏ÏÖò ÏÉùÏÑ± ÏöîÏ≤≠
                        this.sendWebSocketMessage("CREATE_SESSION", {
                            sessionId: sessionId,
                            sessionContext: "Î≥µÏßÄ ÏÉÅÎã¥ ÌÖåÏä§Ìä∏ ÏÑ∏ÏÖòÏûÖÎãàÎã§.",
                            audioContext: "Ïõπ ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω",
                        });
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            this.log(
                                `‚ùå Î©îÏãúÏßÄ ÌååÏã± Ïò§Î•ò: ${error.message}`,
                                "error"
                            );
                        }
                    };

                    this.ws.onclose = () => {
                        this.log("üîå ÏõπÏÜåÏºì Ïó∞Í≤∞ Ï¢ÖÎ£å", "warning");
                        this.updateConnectionStatus("disconnected");
                    };

                    this.ws.onerror = (error) => {
                        this.log(`‚ùå ÏõπÏÜåÏºì Ïò§Î•ò: ${error}`, "error");
                        this.updateConnectionStatus("disconnected");
                    };
                }

                disconnect() {
                    if (this.ws) {
                        this.sendWebSocketMessage("CLOSE_SESSION", {
                            sessionId: this.currentSessionId,
                        });
                        this.ws.close();
                        this.ws = null;
                    }
                    this.currentSessionId = null;
                    this.updateConnectionStatus("disconnected");
                    this.log("üîå Ïó∞Í≤∞ Ï¢ÖÎ£å", "info");
                }

                sendWebSocketMessage(type, data) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const message = { type, data };
                        this.ws.send(JSON.stringify(message));
                        this.log(`üì§ Ï†ÑÏÜ°: ${type}`, "info");
                    }
                }

                handleWebSocketMessage(message) {
                    const { type, data } = message;
                    this.log(`üì• ÏàòÏã†: ${type}`, "info");

                    switch (type) {
                        case "SESSION_CREATED":
                            this.updateSessionInfo();
                            this.log(
                                `‚úÖ ÏÑ∏ÏÖò ÏÉùÏÑ± ÏôÑÎ£å: ${data.sessionId}`,
                                "success"
                            );
                            break;

                        case "TEXT_DELTA":
                            this.currentResponse += data.delta || "";
                            this.updateResponseArea(
                                this.currentResponse + " ‚è≥"
                            );
                            break;

                        case "TEXT_DONE":
                            this.updateResponseArea(this.currentResponse);
                            this.log("‚úÖ ÌÖçÏä§Ìä∏ ÏùëÎãµ ÏôÑÎ£å", "success");
                            this.currentResponse = "";
                            this.messageCount++;
                            this.updateSessionInfo();
                            break;

                        case "AUDIO_TRANSCRIPT_DONE":
                            this.log(
                                `üé§ ÏùåÏÑ± Ï†ÑÏÇ¨ ÏôÑÎ£å: ${data.transcript}`,
                                "info"
                            );
                            break;

                        case "RAG_SOURCES":
                            this.updateRAGSources(data.sources);
                            break;

                        case "SESSION_PAUSED":
                            this.isPaused = true;
                            this.updateSessionInfo();
                            this.log("‚è∏Ô∏è ÏÑ∏ÏÖò ÏùºÏãúÏ†ïÏßÄ", "warning");
                            break;

                        case "SESSION_RESUMED":
                            this.isPaused = false;
                            this.updateSessionInfo();
                            this.log("‚ñ∂Ô∏è ÏÑ∏ÏÖò Ïû¨Í∞ú", "success");
                            break;

                        case "SESSION_INFO":
                            this.updateSessionInfoFromData(data);
                            break;

                        case "ERROR":
                            this.log(`‚ùå Ïò§Î•ò: ${data.message}`, "error");
                            break;

                        default:
                            this.log(
                                `üì® ${type}: ${JSON.stringify(data)}`,
                                "info"
                            );
                    }
                }

                sendMessage() {
                    const message = this.elements.messageInput.value.trim();
                    if (
                        !message ||
                        !this.ws ||
                        this.ws.readyState !== WebSocket.OPEN
                    ) {
                        return;
                    }

                    this.log(`üí¨ Î©îÏãúÏßÄ Ï†ÑÏÜ°: "${message}"`, "info");
                    this.currentResponse = "";
                    this.updateResponseArea("‚è≥ ÏùëÎãµ ÎåÄÍ∏∞ Ï§ë...");

                    this.sendWebSocketMessage("SEND_TEXT_MESSAGE", {
                        sessionId: this.currentSessionId,
                        message: message,
                    });

                    this.elements.messageInput.value = "";
                }

                pauseSession() {
                    this.sendWebSocketMessage("PAUSE_SESSION", {
                        sessionId: this.currentSessionId,
                    });
                }

                resumeSession() {
                    this.sendWebSocketMessage("RESUME_SESSION", {
                        sessionId: this.currentSessionId,
                    });
                }

                getSessionInfo() {
                    this.sendWebSocketMessage("GET_SESSION_INFO", {
                        sessionId: this.currentSessionId,
                    });
                }

                updateConnectionStatus(status) {
                    const statusElement = this.elements.connectionStatus;
                    const isConnected = status === "connected";
                    const isConnecting = status === "connecting";

                    statusElement.className = `status ${status}`;
                    statusElement.textContent = isConnecting
                        ? "Ïó∞Í≤∞ Ï§ë..."
                        : isConnected
                        ? "Ïó∞Í≤∞Îê®"
                        : "Ïó∞Í≤∞ ÎÅäÍπÄ";

                    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    this.elements.connectBtn.disabled =
                        isConnected || isConnecting;
                    this.elements.disconnectBtn.disabled = !isConnected;
                    this.elements.pauseBtn.disabled = !isConnected;
                    this.elements.resumeBtn.disabled = !isConnected;
                    this.elements.sessionInfoBtn.disabled = !isConnected;
                    this.elements.sendBtn.disabled = !isConnected;
                }

                updateSessionInfo() {
                    this.elements.currentSessionId.textContent =
                        this.currentSessionId || "-";
                    this.elements.sessionStatus.textContent = this
                        .currentSessionId
                        ? "ÌôúÏÑ±"
                        : "ÎπÑÌôúÏÑ±";
                    this.elements.pauseStatus.textContent = this.isPaused
                        ? "ÏùºÏãúÏ†ïÏßÄ"
                        : "Ï†ïÏÉÅ";
                    this.elements.messageCount.textContent = this.messageCount;
                }

                updateSessionInfoFromData(data) {
                    this.elements.sessionStatus.textContent = data.active
                        ? "ÌôúÏÑ±"
                        : "ÎπÑÌôúÏÑ±";
                    this.elements.pauseStatus.textContent = data.paused
                        ? "ÏùºÏãúÏ†ïÏßÄ"
                        : "Ï†ïÏÉÅ";
                    this.isPaused = data.paused;
                }

                updateResponseArea(content) {
                    this.elements.responseArea.innerHTML =
                        content ||
                        '<p style="color: #95a5a6; font-style: italic;">ÏùëÎãµÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§...</p>';
                }

                updateRAGSources(sources) {
                    if (sources && sources.length > 0) {
                        this.elements.ragSources.innerHTML = `üîç RAG Ï∂úÏ≤ò: ${sources.join(
                            ", "
                        )}`;
                    } else {
                        this.elements.ragSources.innerHTML = "";
                    }
                }

                log(message, type = "info") {
                    const logEntry = document.createElement("div");
                    logEntry.className = `log-entry ${type}`;
                    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

                    this.elements.eventLog.appendChild(logEntry);
                    this.elements.eventLog.scrollTop =
                        this.elements.eventLog.scrollHeight;
                }

                clearLog() {
                    this.elements.eventLog.innerHTML = "";
                }

                exportLog() {
                    const logText = Array.from(this.elements.eventLog.children)
                        .map((entry) => entry.textContent)
                        .join("\n");

                    const blob = new Blob([logText], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `llm-test-log-${new Date()
                        .toISOString()
                        .slice(0, 19)}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            }

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌÖåÏä§Ìä∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
            document.addEventListener("DOMContentLoaded", () => {
                new LLMTestClient();
            });
        </script>
    </body>
</html>
