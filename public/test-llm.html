<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LLM Service Test</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f7fa;
            }
            .container {
                background: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .section {
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #e1e8ed;
                border-radius: 8px;
                background-color: #fafbfc;
            }
            .section h2 {
                color: #34495e;
                margin-top: 0;
                margin-bottom: 15px;
                font-size: 18px;
            }
            .controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
                margin-bottom: 15px;
            }
            input[type="text"],
            textarea {
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                min-width: 200px;
            }
            textarea {
                min-height: 80px;
                resize: vertical;
            }
            button {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: background-color 0.2s;
            }
            .btn-primary {
                background-color: #3498db;
                color: white;
            }
            .btn-primary:hover {
                background-color: #2980b9;
            }
            .btn-success {
                background-color: #27ae60;
                color: white;
            }
            .btn-success:hover {
                background-color: #229954;
            }
            .btn-warning {
                background-color: #f39c12;
                color: white;
            }
            .btn-warning:hover {
                background-color: #e67e22;
            }
            .btn-danger {
                background-color: #e74c3c;
                color: white;
            }
            .btn-danger:hover {
                background-color: #c0392b;
            }
            .status {
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 15px;
                font-weight: 500;
            }
            .status.connected {
                background-color: #d5f4e6;
                color: #27ae60;
                border: 1px solid #27ae60;
            }
            .status.disconnected {
                background-color: #fadbd8;
                color: #e74c3c;
                border: 1px solid #e74c3c;
            }
            .status.connecting {
                background-color: #fdeaa7;
                color: #f39c12;
                border: 1px solid #f39c12;
            }
            .log {
                background-color: #2c3e50;
                color: #ecf0f1;
                padding: 15px;
                border-radius: 5px;
                height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 12px;
                line-height: 1.4;
            }
            .log-entry {
                margin-bottom: 5px;
                word-wrap: break-word;
            }
            .log-entry.info {
                color: #3498db;
            }
            .log-entry.success {
                color: #27ae60;
            }
            .log-entry.warning {
                color: #f39c12;
            }
            .log-entry.error {
                color: #e74c3c;
            }
            .session-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 15px;
            }
            .info-card {
                background: white;
                padding: 15px;
                border-radius: 5px;
                border-left: 4px solid #3498db;
            }
            .info-card h3 {
                margin: 0 0 10px 0;
                color: #2c3e50;
                font-size: 14px;
            }
            .info-card p {
                margin: 0;
                color: #7f8c8d;
                font-size: 16px;
                font-weight: 500;
            }
            .quick-messages {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
                margin-bottom: 15px;
            }
            .quick-msg {
                background-color: #ecf0f1;
                border: 1px solid #bdc3c7;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                text-align: center;
                font-size: 13px;
                transition: background-color 0.2s;
            }
            .quick-msg:hover {
                background-color: #d5dbdb;
            }
            .response-area {
                background: white;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 15px;
                min-height: 100px;
                margin-top: 10px;
            }
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ¤– LLM Service í…ŒìŠ¤íŠ¸ í™”ë©´</h1>

            <!-- ì—°ê²° ìƒíƒœ -->
            <div class="section">
                <h2>ğŸ“¡ ì›¹ì†Œì¼“ ì—°ê²°</h2>
                <div id="connectionStatus" class="status disconnected">
                    ì—°ê²° ëŠê¹€
                </div>
                <div class="controls">
                    <input
                        type="text"
                        id="sessionId"
                        placeholder="ì„¸ì…˜ ID (ì˜ˆ: test-session-1)"
                        value="test-session-1"
                    />
                    <button id="connectBtn" class="btn-primary">ì—°ê²°</button>
                    <button id="disconnectBtn" class="btn-danger" disabled>
                        ì—°ê²° ëŠê¸°
                    </button>
                </div>
            </div>

            <!-- ì„¸ì…˜ ì •ë³´ -->
            <div class="section">
                <h2>ğŸ“Š ì„¸ì…˜ ì •ë³´</h2>
                <div class="session-info">
                    <div class="info-card">
                        <h3>ì„¸ì…˜ ID</h3>
                        <p id="currentSessionId">-</p>
                    </div>
                    <div class="info-card">
                        <h3>ìƒíƒœ</h3>
                        <p id="sessionStatus">ë¹„í™œì„±</p>
                    </div>
                    <div class="info-card">
                        <h3>ì¼ì‹œì •ì§€</h3>
                        <p id="pauseStatus">ì •ìƒ</p>
                    </div>
                    <div class="info-card">
                        <h3>ë©”ì‹œì§€ ìˆ˜</h3>
                        <p id="messageCount">0</p>
                    </div>
                </div>
                <div class="controls">
                    <button id="pauseBtn" class="btn-warning" disabled>
                        ì¼ì‹œì •ì§€
                    </button>
                    <button id="resumeBtn" class="btn-success" disabled>
                        ì¬ê°œ
                    </button>
                    <button id="sessionInfoBtn" class="btn-primary" disabled>
                        ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
                    </button>
                </div>
            </div>

            <!-- ë©”ì‹œì§€ ì „ì†¡ -->
            <div class="section">
                <h2>ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡</h2>
                <div class="quick-messages">
                    <div
                        class="quick-msg"
                        data-msg="ë³µì§€ í˜œíƒì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”"
                    >
                        ë³µì§€ í˜œíƒ ë¬¸ì˜
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="ì˜ë£Œë¹„ ì§€ì›ì€ ì–´ë–»ê²Œ ë°›ë‚˜ìš”?"
                    >
                        ì˜ë£Œë¹„ ì§€ì› ë¬¸ì˜
                    </div>
                    <div class="quick-msg" data-msg="ì£¼ê±° ì§€ì› ì •ì±…ì´ ìˆë‚˜ìš”?">
                        ì£¼ê±° ì§€ì› ë¬¸ì˜
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="êµìœ¡ë¹„ ì§€ì› ì œë„ê°€ ê¶ê¸ˆí•©ë‹ˆë‹¤"
                    >
                        êµìœ¡ë¹„ ì§€ì› ë¬¸ì˜
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="êµí†µë¹„ í• ì¸ í˜œíƒì€ ë­ê°€ ìˆë‚˜ìš”?"
                    >
                        êµí†µë¹„ í• ì¸ ë¬¸ì˜
                    </div>
                    <div
                        class="quick-msg"
                        data-msg="ì•ˆë…•í•˜ì„¸ìš”. ì²˜ìŒ ì´ìš©í•©ë‹ˆë‹¤."
                    >
                        ì¸ì‚¬ë§
                    </div>
                </div>
                <div class="controls">
                    <textarea
                        id="messageInput"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    ></textarea>
                    <button id="sendBtn" class="btn-success" disabled>
                        ì „ì†¡
                    </button>
                </div>
                <div
                    id="ragSources"
                    style="margin-top: 10px; font-size: 12px; color: #7f8c8d"
                ></div>
                <div class="response-area" id="responseArea">
                    <p style="color: #95a5a6; font-style: italic">
                        ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                    </p>
                </div>
            </div>

            <!-- ì´ë²¤íŠ¸ ë¡œê·¸ -->
            <div class="section">
                <h2>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
                <div class="controls">
                    <button id="clearLogBtn" class="btn-warning">
                        ë¡œê·¸ ì§€ìš°ê¸°
                    </button>
                    <button id="exportLogBtn" class="btn-primary">
                        ë¡œê·¸ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
                <div id="eventLog" class="log"></div>
            </div>
        </div>

        <script>
            class LLMTestClient {
                constructor() {
                    this.ws = null;
                    this.currentSessionId = null;
                    this.messageCount = 0;
                    this.isPaused = false;
                    this.currentResponse = "";

                    this.initElements();
                    this.bindEvents();
                    this.log("ğŸš€ LLM í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ", "success");
                }

                initElements() {
                    this.elements = {
                        sessionId: document.getElementById("sessionId"),
                        connectBtn: document.getElementById("connectBtn"),
                        disconnectBtn: document.getElementById("disconnectBtn"),
                        connectionStatus:
                            document.getElementById("connectionStatus"),
                        currentSessionId:
                            document.getElementById("currentSessionId"),
                        sessionStatus: document.getElementById("sessionStatus"),
                        pauseStatus: document.getElementById("pauseStatus"),
                        messageCount: document.getElementById("messageCount"),
                        pauseBtn: document.getElementById("pauseBtn"),
                        resumeBtn: document.getElementById("resumeBtn"),
                        sessionInfoBtn:
                            document.getElementById("sessionInfoBtn"),
                        messageInput: document.getElementById("messageInput"),
                        sendBtn: document.getElementById("sendBtn"),
                        ragSources: document.getElementById("ragSources"),
                        responseArea: document.getElementById("responseArea"),
                        eventLog: document.getElementById("eventLog"),
                        clearLogBtn: document.getElementById("clearLogBtn"),
                        exportLogBtn: document.getElementById("exportLogBtn"),
                    };
                }

                bindEvents() {
                    this.elements.connectBtn.addEventListener("click", () =>
                        this.connect()
                    );
                    this.elements.disconnectBtn.addEventListener("click", () =>
                        this.disconnect()
                    );
                    this.elements.pauseBtn.addEventListener("click", () =>
                        this.pauseSession()
                    );
                    this.elements.resumeBtn.addEventListener("click", () =>
                        this.resumeSession()
                    );
                    this.elements.sessionInfoBtn.addEventListener("click", () =>
                        this.getSessionInfo()
                    );
                    this.elements.sendBtn.addEventListener("click", () =>
                        this.sendMessage()
                    );
                    this.elements.clearLogBtn.addEventListener("click", () =>
                        this.clearLog()
                    );
                    this.elements.exportLogBtn.addEventListener("click", () =>
                        this.exportLog()
                    );

                    // ë¹ ë¥¸ ë©”ì‹œì§€ ë²„íŠ¼ë“¤
                    document.querySelectorAll(".quick-msg").forEach((btn) => {
                        btn.addEventListener("click", (e) => {
                            const message = e.target.getAttribute("data-msg");
                            this.elements.messageInput.value = message;
                            this.sendMessage();
                        });
                    });

                    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
                    this.elements.messageInput.addEventListener(
                        "keypress",
                        (e) => {
                            if (e.key === "Enter" && !e.shiftKey) {
                                e.preventDefault();
                                this.sendMessage();
                            }
                        }
                    );
                }

                connect() {
                    const sessionId = this.elements.sessionId.value.trim();
                    if (!sessionId) {
                        alert("ì„¸ì…˜ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    this.log(`ğŸ”— ì„¸ì…˜ ì—°ê²° ì‹œë„: ${sessionId}`, "info");
                    this.updateConnectionStatus("connecting");

                    this.ws = new WebSocket("ws://localhost:3000/voice");
                    this.currentSessionId = sessionId;

                    this.ws.onopen = () => {
                        this.log("âœ… ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ", "success");
                        this.updateConnectionStatus("connected");

                        // ì„¸ì…˜ ìƒì„± ìš”ì²­
                        this.sendWebSocketMessage("CREATE_SESSION", {
                            sessionId: sessionId,
                            sessionContext: "ë³µì§€ ìƒë‹´ í…ŒìŠ¤íŠ¸ ì„¸ì…˜ì…ë‹ˆë‹¤.",
                            audioContext: "ì›¹ í…ŒìŠ¤íŠ¸ í™˜ê²½",
                        });
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            this.log(
                                `âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error.message}`,
                                "error"
                            );
                        }
                    };

                    this.ws.onclose = () => {
                        this.log("ğŸ”Œ ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ", "warning");
                        this.updateConnectionStatus("disconnected");
                    };

                    this.ws.onerror = (error) => {
                        this.log(`âŒ ì›¹ì†Œì¼“ ì˜¤ë¥˜: ${error}`, "error");
                        this.updateConnectionStatus("disconnected");
                    };
                }

                disconnect() {
                    if (this.ws) {
                        this.sendWebSocketMessage("CLOSE_SESSION", {
                            sessionId: this.currentSessionId,
                        });
                        this.ws.close();
                        this.ws = null;
                    }
                    this.currentSessionId = null;
                    this.updateConnectionStatus("disconnected");
                    this.log("ğŸ”Œ ì—°ê²° ì¢…ë£Œ", "info");
                }

                sendWebSocketMessage(type, data) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const message = { type, data };
                        this.ws.send(JSON.stringify(message));
                        this.log(`ğŸ“¤ ì „ì†¡: ${type}`, "info");
                    }
                }

                handleWebSocketMessage(message) {
                    const { type, data } = message;
                    this.log(`ğŸ“¥ ìˆ˜ì‹ : ${type}`, "info");

                    switch (type) {
                        case "SESSION_CREATED":
                            this.updateSessionInfo();
                            this.log(
                                `âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ: ${data.sessionId}`,
                                "success"
                            );
                            break;

                        case "TEXT_DELTA":
                            this.currentResponse += data.delta || "";
                            this.updateResponseArea(
                                this.currentResponse + " â³"
                            );
                            break;

                        case "TEXT_DONE":
                            this.updateResponseArea(this.currentResponse);
                            this.log("âœ… í…ìŠ¤íŠ¸ ì‘ë‹µ ì™„ë£Œ", "success");
                            this.currentResponse = "";
                            this.messageCount++;
                            this.updateSessionInfo();
                            break;

                        case "AUDIO_TRANSCRIPT_DONE":
                            this.log(
                                `ğŸ¤ ìŒì„± ì „ì‚¬ ì™„ë£Œ: ${data.transcript}`,
                                "info"
                            );
                            break;

                        case "RAG_SOURCES":
                            this.updateRAGSources(data.sources);
                            break;

                        case "SESSION_PAUSED":
                            this.isPaused = true;
                            this.updateSessionInfo();
                            this.log("â¸ï¸ ì„¸ì…˜ ì¼ì‹œì •ì§€", "warning");
                            break;

                        case "SESSION_RESUMED":
                            this.isPaused = false;
                            this.updateSessionInfo();
                            this.log("â–¶ï¸ ì„¸ì…˜ ì¬ê°œ", "success");
                            break;

                        case "SESSION_INFO":
                            this.updateSessionInfoFromData(data);
                            break;

                        case "ERROR":
                            this.log(`âŒ ì˜¤ë¥˜: ${data.message}`, "error");
                            break;

                        default:
                            this.log(
                                `ğŸ“¨ ${type}: ${JSON.stringify(data)}`,
                                "info"
                            );
                    }
                }

                sendMessage() {
                    const message = this.elements.messageInput.value.trim();
                    if (
                        !message ||
                        !this.ws ||
                        this.ws.readyState !== WebSocket.OPEN
                    ) {
                        return;
                    }

                    this.log(`ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡: "${message}"`, "info");
                    this.currentResponse = "";
                    this.updateResponseArea("â³ ì‘ë‹µ ëŒ€ê¸° ì¤‘...");

                    this.sendWebSocketMessage("SEND_TEXT_MESSAGE", {
                        sessionId: this.currentSessionId,
                        message: message,
                    });

                    this.elements.messageInput.value = "";
                }

                pauseSession() {
                    this.sendWebSocketMessage("PAUSE_SESSION", {
                        sessionId: this.currentSessionId,
                    });
                }

                resumeSession() {
                    this.sendWebSocketMessage("RESUME_SESSION", {
                        sessionId: this.currentSessionId,
                    });
                }

                getSessionInfo() {
                    this.sendWebSocketMessage("GET_SESSION_INFO", {
                        sessionId: this.currentSessionId,
                    });
                }

                updateConnectionStatus(status) {
                    const statusElement = this.elements.connectionStatus;
                    const isConnected = status === "connected";
                    const isConnecting = status === "connecting";

                    statusElement.className = `status ${status}`;
                    statusElement.textContent = isConnecting
                        ? "ì—°ê²° ì¤‘..."
                        : isConnected
                        ? "ì—°ê²°ë¨"
                        : "ì—°ê²° ëŠê¹€";

                    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    this.elements.connectBtn.disabled =
                        isConnected || isConnecting;
                    this.elements.disconnectBtn.disabled = !isConnected;
                    this.elements.pauseBtn.disabled = !isConnected;
                    this.elements.resumeBtn.disabled = !isConnected;
                    this.elements.sessionInfoBtn.disabled = !isConnected;
                    this.elements.sendBtn.disabled = !isConnected;
                }

                updateSessionInfo() {
                    this.elements.currentSessionId.textContent =
                        this.currentSessionId || "-";
                    this.elements.sessionStatus.textContent = this
                        .currentSessionId
                        ? "í™œì„±"
                        : "ë¹„í™œì„±";
                    this.elements.pauseStatus.textContent = this.isPaused
                        ? "ì¼ì‹œì •ì§€"
                        : "ì •ìƒ";
                    this.elements.messageCount.textContent = this.messageCount;
                }

                updateSessionInfoFromData(data) {
                    this.elements.sessionStatus.textContent = data.active
                        ? "í™œì„±"
                        : "ë¹„í™œì„±";
                    this.elements.pauseStatus.textContent = data.paused
                        ? "ì¼ì‹œì •ì§€"
                        : "ì •ìƒ";
                    this.isPaused = data.paused;
                }

                updateResponseArea(content) {
                    this.elements.responseArea.innerHTML =
                        content ||
                        '<p style="color: #95a5a6; font-style: italic;">ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>';
                }

                updateRAGSources(sources) {
                    if (sources && sources.length > 0) {
                        this.elements.ragSources.innerHTML = `ğŸ” RAG ì¶œì²˜: ${sources.join(
                            ", "
                        )}`;
                    } else {
                        this.elements.ragSources.innerHTML = "";
                    }
                }

                log(message, type = "info") {
                    const logEntry = document.createElement("div");
                    logEntry.className = `log-entry ${type}`;
                    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

                    this.elements.eventLog.appendChild(logEntry);
                    this.elements.eventLog.scrollTop =
                        this.elements.eventLog.scrollHeight;
                }

                clearLog() {
                    this.elements.eventLog.innerHTML = "";
                }

                exportLog() {
                    const logText = Array.from(this.elements.eventLog.children)
                        .map((entry) => entry.textContent)
                        .join("\n");

                    const blob = new Blob([logText], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `llm-test-log-${new Date()
                        .toISOString()
                        .slice(0, 19)}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
            document.addEventListener("DOMContentLoaded", () => {
                new LLMTestClient();
            });
        </script>
    </body>
</html>
